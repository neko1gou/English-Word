<!DOCTYPE html>
<html lang="ja">
    <head>
        <!--文字コードを指定-->
        <meta charset="UTF-8">
        <!--タイトルを指定-->
        <title>
            English word practice
        </title>
        <!--CSSの記述-->
        <style>
            html{
                text-align: center;
                font-family: sans-serif;
            }
            span{
                border: solid 5px #aaa;
                border-radius: 5px;
            }
        </style>
    </head>
    <body>
        <div id="run"></div>
        <!--JavaScriptの記述-->
        <script>
            // github raw url を定数として保存
            const URL_WORD = 'https://raw.githubusercontent.com/neko1gou/English-Word/refs/heads/main/word.txt';
            const URL_MEAN = 'https://raw.githubusercontent.com/neko1gou/English-Word/refs/heads/main/mean.txt';
            //divに変更を与えるための定数
            const DIV_ROAD = document.getElementById('run');
            //問題の範囲を指定する際に使うもの
            let startId = 0
            let endId = 24
            let alphabetList = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','Y','Z']
            let startNum = [1,149,275,478,568,660,804,880,1000,1078,1096,1118,1215,1324,1395,1478,1609,1617,1721,1989,2178,2208,2230,2362,2379]
            let endNum =[148,274,477,567,659,803,879,999,1077,1095,1117,1214,1323,1394,1477,1608,1616,1720,1988,2177,2207,2229,2361,2378,2382]
            let wordNum = []
            //ward、 meanの格納の配列の宣言
            let word =[];
            let mean =[];
            let wordCount = String( endNum[endId] - startNum[startId]+1)
            //ファイルの読み込みが終わった際に変化を示す値を出力する変数の宣言
            let FINISH_ROADING = 0;
            //ファイルの取得をして結果を word、meanに代入する関数を作成
            async function fetchAndProcessFiles() {
                DIV_ROAD.innerHTML='ファイルの取得を開始しました。';
                try {
                    //txtファイルの取得
                    const [RES_WORD,RES_MEAN]=await Promise.all([
                        fetch(URL_WORD),
                        fetch(URL_MEAN)
                    ]);
                    //エラーの発生がないか
                    if (!RES_WORD.ok || !RES_MEAN.ok) {
                        エラーの発生があった場合
                        const STATUS_WORD =RES_WORD.status
                        const STATUS_MEAN =RES_MEAN.status
                        throw new Error(`ファイルの読み込みに失敗しました。HTTPエラー: Word=${STATUS_WORD}, Mean=${STATUS_MEAN}`);
                    }
                    //ファイルの内容を抽出
                    const [TXT_WORD,TXT_MEAN] = await Promise.all([
                        RES_WORD.text(),
                        RES_MEAN.text()
                    ]);
                    //ファイルの整理
                    const wordArray = TXT_WORD
                    .split('\n')
                    .map(line=>line.trim())
                    .filter(line=>line.length>0);
                    const meanArray = TXT_MEAN
                    .split('\n')
                    .map(line=>line.trim())
                    .filter(line=>line.length>0);
                    DIV_ROAD.innerHTML = '読み込みが完了。5秒後、プログラムを開始します。';
                    word = wordArray;
                    mean = meanArray;
                    FINISH_ROADING = 1;
                    setTimeout(load,5000)
                } catch (error) {
                    //エラーの発生
                    FINISH_ROADING=2;
                    const errorMessage = `❌ エラーが発生しました: ${error.message}5秒後に再読み込みします。`;
                    DIV_ROAD.innerHTML=errorMessage;
                    setTimeout(load,5000)
                };
            }
            function load() {
                if (FINISH_ROADING == 1) {
                     DIV_ROAD.innerHTML=`
                    <h1>
                        <span id = 'start'></span>の初めから<span id = 'end'></span>の終わり
                    </h1>
                    <h2 id = 'wordcount'>
                    </h2>
                    <h3>
                    ファイルを読み込む
                    </h3>
                    <label for="missFile">間違えた問題リスト (.txt):</label><br>
                    <input type="file" id="missFile" accept=".txt"><br>
                    <button id="missLoad">
                        間違えた問題リストをロード
                    </button><br><br>
                    <button id ='button'>
                    スタート
                    </button>
                    `
                    document.getElementById('start').textContent = alphabetList[startId]
                    document.getElementById('end').textContent = alphabetList[endId]
                    document.getElementById('wordcount').textContent = '単語数:'+wardCount+'単語'
                    document.getElementById('start').onclick = function() {
                        if (startId >23){
                            startId =0
                        }else{
                            startId +=1
                            if(endId < startId){
                                endId =startId
                            }
                        }
                        wordCount = String( endNum[endId] - startNum[startId]+1)
                        document.getElementById('start').textContent = alphabetList[startId]
                        document.getElementById('end').textContent = alphabetList[endId]
                        document.getElementById('wordcount').textContent = '単語数:'+wardCount+'単語'
                    }
                    document.getElementById('end').onclick = function() {
                        if (endId > 23) {
                            endId=0
                            startId =0
                        } else {
                            endId += 1
                        }
                        wordCount = String( endNum[endId] - startNum[startId]+1)
                        document.getElementById('start').textContent = alphabetList[startId]
                        document.getElementById('end').textContent = alphabetList[endId]
                        document.getElementById('wordcount').textContent = '単語数:'+wardCount+'単語'
                    }
                }else{
                    location.reload()
                }
                document.getElementById('missLoad').onclick = function(){
                    missAns()
                }
                document.getElementById('button').onclick = function(){
                    startQuestion()
                }
            }
            function missAns() {
                const missFileImput = document.getElementById('missFile')
                const missFile = missFileInput.files[0];
                if (!errorFile) {
                    load();
                    return;
                };
                if (FINISH_ROADING !== 1) {
                    load();
                    return;
                };
                const reader = new FileReader();
                reader.onload = function (e) {
                    const TXT_MISS = e.target.result;
                    const misslines = TXT_MISS
                    .split(/[\n,]/) 
                    .map(line => parseInt(line.trim()))
                    .filter(num => !isNaN(num) && num > 0)
                    .filter((num, index, self) => self.indexOf(num) === index)
                    .sort((a, b) => a - b);
                    wordNum = misslines.map(line => line - 1);
                    startQuestion()
                }
            }
            function startQuestion () {
                //問題出題
                if (wordNum.length == 0) {
                    let i = startNum[startId]-1
                    while(i >= wordCount){
                        wordNum.push(i)
                        i +=1
                    }
                }
                DIV_ROAD.innerHTML=`
                <h1 id ='question'></h1>
                <form action='#' id='form'>
                    <input type='text' name='ans'>
                    <br>
                    <input type='submit' value='答える'>
                </form>
                `
            }
            fetchAndProcessFiles();
        </script>
    </body>
</html>